<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auto Chess Dashboard</title>
    <!-- ‡§Ö‡§™‡§°‡•á‡§ü‡•á‡§° chessboard.css ‡§≤‡§ø‡§Ç‡§ï -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f5f5f5; margin: 0; padding: 20px; }
        h2 { color: #333; }
        button { font-size: 16px; padding: 10px 20px; margin: 10px; cursor: pointer; border: none; border-radius: 5px; background: #4CAF50; color: white; }
        button:hover { background: #45a049; }
        #status { font-weight: bold; margin-top: 10px; padding: 10px; background: white; border-radius: 5px; display: inline-block; }
        #timer { margin-top: 10px; font-size: 16px; font-weight: bold; }
        #board { width: 400px; margin: 20px auto; }
        #controls { margin-top: 20px; }
    </style>
</head>
<body>

<h2>‚ôüÔ∏è Chess Dashboard</h2>

<div id="status">Loading game...</div>
<div id="timer">White: 10:00 | Black: 10:00</div>
<div id="board"></div>

<div id="controls">
    <button onclick="startSystemGame()">üîÑ New Game vs System</button>
</div>

<!-- ‡§Ö‡§™‡§°‡•á‡§ü‡•á‡§° ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§≤‡§ø‡§Ç‡§ï‡•ç‡§∏ -->
<script src="https://unpkg.com/chess.js@1.0.0-beta.9/dist/chess.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

// Firebase config (‡§Ü‡§™‡§ï‡§æ original config)
const firebaseConfig = {
  apiKey: "AIzaSyACIKwrp-KV6o2vRM6adXESjU1-OpbVscc",
  authDomain: "cess-cb730.firebaseapp.com",
  databaseURL: "https://cess-cb730-default-rtdb.firebaseio.com",
  projectId: "cess-cb730",
  storageBucket: "cess-cb730.firebasestorage.app",
  messagingSenderId: "324360812002",
  appId: "1:324360812002:web:6a9bedb2cfc67db41a75bb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let uid, game, board, myColor = "white";
let timerInterval, whiteTime = 600, blackTime = 600; // 600 seconds = 10 minutes

const statusEl = document.getElementById("status");
const timerEl = document.getElementById("timer");

// Anonymous authentication
signInAnonymously(auth)
.then(res => {
  uid = res.user.uid;
  console.log("Logged in UID:", uid);
  startSystemGame(); // Automatically start a game against the system
})
.catch(err => {
  console.log("Auth Error:", err);
  statusEl.innerText = "Authentication Error - Starting Offline Game";
  startSystemGame(); // Fallback: start game even if auth fails
});

// ==================== Initialize Board ====================
function initBoard() {
  game = new Chess();
  board = Chessboard('board', {
    draggable: true,
    position: 'start',
    orientation: myColor,
    onDrop: onDrop
  });
  updateStatus();
  startTimer();
}

// ==================== Start System Game ====================
function startSystemGame() {
  myColor = "white";
  statusEl.innerText = "System Game | You (White) vs Computer | Playing...";
  whiteTime = 600;
  blackTime = 600;
  if (timerInterval) clearInterval(timerInterval);
  initBoard();
}

// ==================== Handle Piece Drop ====================
function onDrop(source, target) {
  // Validate move
  const move = game.move({
    from: source,
    to: target,
    promotion: 'q' // Always promote to queen for simplicity
  });

  if (move === null) return 'snapback'; // Invalid move

  board.position(game.fen());
  updateStatus();

  // System makes a move after a short delay
  if (!game.game_over()) {
    setTimeout(systemMove, 500);
  }
}

// ==================== System AI Move ====================
function systemMove() {
  if (game.game_over()) return;

  const moves = game.moves();
  if (moves.length === 0) return;

  const randomMove = moves[Math.floor(Math.random() * moves.length)];
  game.move(randomMove);
  board.position(game.fen());
  updateStatus();
}

// ==================== Update Game Status ====================
function updateStatus() {
  if (game.game_over()) {
    if (game.in_checkmate()) {
      const winner = game.turn() === 'w' ? 'Black' : 'White';
      statusEl.innerText = `Checkmate! ${winner} wins.`;
    } else if (game.in_draw()) {
      statusEl.innerText = 'Game drawn.';
    } else if (game.in_stalemate()) {
      statusEl.innerText = 'Stalemate!';
    } else {
      statusEl.innerText = 'Game over.';
    }
    stopTimer();
    return;
  }

  const moveColor = game.turn() === 'w' ? 'White' : 'Black';
  const status = `${moveColor} to move`;
  statusEl.innerText = game.in_check() ? `${status} (Check!)` : status;
}

// ==================== Timer Functions ====================
function startTimer() {
  timerInterval = setInterval(() => {
    if (game.turn() === 'w') {
      whiteTime--;
    } else {
      blackTime--;
    }

    timerEl.innerText = `White: ${formatTime(whiteTime)} | Black: ${formatTime(blackTime)}`;

    if (whiteTime <= 0) {
      statusEl.innerText = "White's time is up! Black wins.";
      stopTimer();
    } else if (blackTime <= 0) {
      statusEl.innerText = "Black's time is up! White wins.";
      stopTimer();
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
}

function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}
</script>
</body>
</html>
