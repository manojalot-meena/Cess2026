<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Online Chess</title>

<!-- Chessboard CSS -->
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.css"/>

<style>
body {
  font-family: Arial;
  text-align: center;
}
#board {
  width: 320px;
  margin: 20px auto;
}
#status {
  font-weight: bold;
  margin-top: 10px;
}
</style>
</head>

<body>

<h2>♟️ Online Chess</h2>
<div id="status">Connecting...</div>
<div id="board"></div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.js"></script>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyACIKwrp-KV6o2vRM6adXESjU1-OpbVscc",
  authDomain: "cess-cb730.firebaseapp.com",
  databaseURL: "https://cess-cb730-default-rtdb.firebaseio.com",
  projectId: "cess-cb730",
  storageBucket: "cess-cb730.firebasestorage.app",
  messagingSenderId: "324360812002",
  appId: "1:324360812002:web:6a9bedb2cfc67db41a75bb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ================= GAME VARS ================= */
let game = new Chess();
let board;
let myColor = "white";
let roomId;
let uid;

/* ================= AUTH ================= */
signInAnonymously(auth).then(res => {
  uid = res.user.uid;
  findOrCreateRoom();
});

/* ================= ROOM LOGIC ================= */
function findOrCreateRoom() {
  const roomsRef = ref(db, "rooms");

  onValue(roomsRef, snap => {
    let joined = false;

    snap.forEach(room => {
      const data = room.val();
      if (!data.black && data.white !== uid) {
        roomId = room.key;
        myColor = "black";
        update(ref(db, "rooms/" + roomId), {
          black: uid
        });
        joined = true;
      }
    });

    if (!joined) {
      const newRoom = push(roomsRef);
      roomId = newRoom.key;
      myColor = "white";
      set(newRoom, {
        white: uid,
        fen: game.fen()
      });
    }

    startGame();
  }, { onlyOnce: true });
}

/* ================= START GAME ================= */
function startGame() {
  document.getElementById("status").innerText =
    "You are " + myColor.toUpperCase();

  board = Chessboard("board", {
    draggable: true,
    position: "start",
    orientation: myColor,
    onDrop: onDrop
  });

  listenMoves();
}

/️}

/* ================= MOVE ================= */
function onDrop(source, target) {
  if ((game.turn() === "w" && myColor !== "white") ||
      (game.turn() === "b" && myColor !== "black")) {
    return "snapback";
  }

  const move = game.move({
    from: source,
    to: target,
    promotion: "q"
  });

  if (move === null) return "snapback";

  set(ref(db, "rooms/" + roomId + "/fen"), game.fen());
}

/* ================= LISTEN ================= */
function listenMoves() {
  onValue(ref(db, "rooms/" + roomId + "/fen"), snap => {
    const fen = snap.val();
    if (fen && fen !== game.fen()) {
      game.load(fen);
      board.position(fen);
    }
  });
}

</script>
</body>
</html>
