<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chess Online</title>
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.css"/>
<style>
body { font-family: Arial; text-align: center; }
#board { width: 320px; margin: 20px auto; }
#status { font-weight: bold; margin-top: 10px; }
</style>
</head>
<body>

<h2>♟️ Online Chess</h2>
<div id="status">Connecting...</div>
<div id="board"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyACIKwrp-KV6o2vRM6adXESjU1-OpbVscc",
  authDomain: "cess-cb730.firebaseapp.com",
  databaseURL: "https://cess-cb730-default-rtdb.firebaseio.com",
  projectId: "cess-cb730",
  storageBucket: "cess-cb730.firebasestorage.app",
  messagingSenderId: "324360812002",
  appId: "1:324360812002:web:6a9bedb2cfc67db41a75bb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let game = new Chess();
let board;
let myColor = "white";
let roomId = null;
let uid;
let onlineMode = false;

// Init board immediately to avoid "connecting"
function initBoard() {
  board = Chessboard('board', {
    draggable: true,
    position: 'start',
    orientation: myColor,
    onDrop: onDrop
  });
}

// Auth & start
signInAnonymously(auth)
.then(res => {
  uid = res.user.uid;
  document.getElementById("status").innerText = "Searching opponent...";
  initBoard();
  searchRoomWithTimeout();
})
.catch(err => {
  document.getElementById("status").innerText = "Auth error: " + err.message;
});

// Search opponent in background with fallback
function searchRoomWithTimeout() {
  const roomsRef = ref(db, "rooms");
  let found = false;

  // Try to find opponent
  onValue(roomsRef, snap => {
    snap.forEach(room => {
      const data = room.val();
      if (!data.black && data.white !== uid && !found) {
        found = true;
        onlineMode = true;
        roomId = room.key;
        myColor = "black";
        update(ref(db, "rooms/" + roomId), { black: uid });
        document.getElementById("status").innerText = "Online Game | You are BLACK";
        listenMoves();
      }
    });
  });

  // Fallback: after 3 sec start system mode
  setTimeout(() => {
    if (!found) {
      document.getElementById("status").innerText = "System Game | You vs Computer";
      myColor = "white";
      onlineMode = false;
      initBoard();
    }
  }, 3000);
}

// Moves
function onDrop(source, target) {
  if (onlineMode) {
    if ((game.turn() === "w" && myColor !== "white") ||
        (game.turn() === "b" && myColor !== "black")) {
      return 'snapback';
    }
  }

  const move = game.move({from: source, to: target, promotion: 'q'});
  if (!move) return 'snapback';
  board.position(game.fen());

  if (onlineMode) {
    set(ref(db, "rooms/" + roomId + "/fen"), game.fen());
  } else {
    setTimeout(systemMove, 500);
  }
}

// System AI
function systemMove() {
  if (game.game_over()) return;
  const moves = game.moves();
  const move = moves[Math.floor(Math.random()*moves.length)];
  game.move(move);
  board.position(game.fen());
}

// Listen online
function listenMoves() {
  onValue(ref(db, "rooms/" + roomId + "/fen"), snap => {
    const fen = snap.val();
    if (fen && fen !== game.fen()) {
      game.load(fen);
      board.position(fen);
    }
  });
}
</script>

</body>
</html>
