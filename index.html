<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Auto Chess Dashboard</title>
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.css"/>
<style>
body { font-family: Arial; text-align: center; background:#f5f5f5; }
#dashboard { margin-top:30px; display:none; } /* hide dashboard since auto start */
button { font-size:16px; padding:10px 20px; margin:10px; cursor:pointer; }
#board { width: 320px; margin: 20px auto; }
#status { font-weight:bold; margin-top:10px; }
#timer { margin-top:10px; font-size:16px; }
</style>
</head>
<body>

<h2>♟️ Chess Dashboard</h2>

<div id="status">Loading game...</div>
<div id="timer"></div>
<div id="board"></div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, update, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyACIKwrp-KV6o2vRM6adXESjU1-OpbVscc",
  authDomain: "cess-cb730.firebaseapp.com",
  databaseURL: "https://cess-cb730-default-rtdb.firebaseio.com",
  projectId: "cess-cb730",
  storageBucket: "cess-cb730.firebasestorage.app",
  messagingSenderId: "324360812002",
  appId: "1:324360812002:web:6a9bedb2cfc67db41a75bb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Variables
let uid, game, board, myColor="white", roomId, onlineMode=false;
let timerInterval, whiteTime=600, blackTime=600; // 10 min each

const statusEl = document.getElementById("status");
const boardDiv = document.getElementById("board");
const timerEl = document.getElementById("timer");

// Auth anonymous
signInAnonymously(auth)
.then(res => {
  uid = res.user.uid;
  console.log("Logged in UID:", uid);
  startSystemGame(); // auto start system game immediately
})
.catch(err => { console.log("Auth Error:", err); statusEl.innerText="Auth Error"; });

// ==================== Init Board ====================
function initBoard(){
  game = new Chess();
  board = Chessboard("board",{
    draggable:true,
    position:"start",
    orientation:myColor,
    onDrop:onDrop
  });
  updateStatus();
  startTimer();
}

// ==================== System Game ====================
function startSystemGame(){
  onlineMode=false;
  myColor="white";
  statusEl.innerText="System Game | You vs Computer | Playing...";
  initBoard();
}

// ==================== Moves ====================
function onDrop(source,target){
  if(onlineMode){
    if((game.turn()==="w" && myColor!=="white") ||
       (game.turn()==="b" && myColor!=="black")) return "snapback";
  }

  const move = game.move({from:source,to:target,promotion:'q'});
  if(!move) return "snapback";
  board.position(game.fen());
  updateStatus();

  if(!onlineMode){
    setTimeout(systemMove,500);
  }
}

// ==================== System AI ====================
function systemMove(){
  if(game.game_over()) return;
  const moves = game.moves();
  const move = moves[Math.floor(Math.random()*moves.length)];
  game.move(move);
  board.position(game.fen());
  updateStatus();
}

// ==================== Status & Win Check ====================
function updateStatus(){
  let status = '';
  let moveColor = game.turn() === 'w' ? 'White' : 'Black';

  if(game.in_checkmate()){
    status = 'Checkmate! ' + (moveColor==='White'?'Black':'White') + ' wins.';
    stopTimer();
  } else if(game.in_draw() || game.in_stalemate() || game.in_threefold_repetition()){
    status = 'Draw!';
    stopTimer();
  } else{
    status = 'Playing... ' + moveColor + ' to move';
  }
  statusEl.innerText = status;
}

// ==================== Timer ====================
function startTimer(){
  timerInterval = setInterval(()=>{
    if(game.turn()==='w') whiteTime--; else blackTime--;
    timerEl.innerText = `White: ${formatTime(whiteTime)} | Black: ${formatTime(blackTime)}`;
    if(whiteTime<=0 || blackTime<=0){
      clearInterval(timerInterval);
      statusEl.innerText = (whiteTime<=0?'White':'Black') + ' time over. Game Over';
    }
  },1000);
}

function stopTimer(){
  clearInterval(timerInterval);
}

function formatTime(sec){
  let m = Math.floor(sec/60);
  let s = sec%60;
  return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}
</script>
</body>
</html>
