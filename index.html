<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Online Chess</title>

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.css"/>

<style>
body { font-family: Arial; text-align: center; }
#board { width: 320px; margin: 20px auto; }
#status { font-weight: bold; margin-top: 10px; }
</style>
</head>

<body>

<h2>‚ôüÔ∏è Online Chess</h2>
<div id="status">Connecting...</div>
<div id="board"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* üî• Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyACIKwrp-KV6o2vRM6adXESjU1-OpbVscc",
  authDomain: "cess-cb730.firebaseapp.com",
  databaseURL: "https://cess-cb730-default-rtdb.firebaseio.com",
  projectId: "cess-cb730",
  storageBucket: "cess-cb730.firebasestorage.app",
  messagingSenderId: "324360812002",
  appId: "1:324360812002:web:6a9bedb2cfc67db41a75bb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* GAME */
let game = new Chess();
let board;
let myColor = "white";
let roomId = null;
let uid;
let onlineMode = false;

/* AUTH */
signInAnonymously(auth).then(res => {
  uid = res.user.uid;
  searchRoomWithTimeout();
});

/* üîç SEARCH ROOM (5 sec) */
function searchRoomWithTimeout() {
  document.getElementById("status").innerText = "Searching opponent...";

  const roomsRef = ref(db, "rooms");
  let found = false;

  onValue(roomsRef, snap => {
    if (found) return;

    snap.forEach(room => {
      const data = room.val();
      if (!data.black && data.white !== uid) {
        found = true;
        onlineMode = true;
        roomId = room.key;
        myColor = "black";
        update(ref(db, "rooms/" + roomId), { black: uid });
        startOnlineGame();
      }
    });
  }, { onlyOnce: true });

  setTimeout(() => {
    if (!found) {
      startSystemGame();
    }
  }, 5000);
}

/* ‚ñ∂Ô∏è ONLINE GAME */
function startOnlineGame() {
  document.getElementById("status").innerText =
    "Online Game | You are " + myColor.toUpperCase();

  initBoard();
  listenMoves();
}

/* ü§ñ SYSTEM GAME */
function startSystemGame() {
  document.getElementById("status").innerText =
    "System Game | You vs Computer";

  myColor = "white";
  initBoard();
}

/* ‚ôüÔ∏è BOARD */
function initBoard() {
  board = Chessboard("board", {
    draggable: true,
    position: "start",
    orientation: myColor,
    onDrop: onDrop
  });
}

/* MOVE */
function onDrop(source, target) {
  if (onlineMode) {
    if ((game.turn() === "w" && myColor !== "white") ||
        (game.turn() === "b" && myColor !== "black")) {
      return "snapback";
    }
  }

  const move = game.move({
    from: source,
    to: target,
    promotion: "q"
  });

  if (!move) return "snapback";

  board.position(game.fen());

  if (onlineMode) {
    set(ref(db, "rooms/" + roomId + "/fen"), game.fen());
  } else {
    setTimeout(systemMove, 500);
  }
}

/* SYSTEM AI (Random) */
function systemMove() {
  if (game.game_over()) return;
  const moves = game.moves();
  const move = moves[Math.floor(Math.random() * moves.length)];
  game.move(move);
  board.position(game.fen());
}

/* LISTEN ONLINE */
function listenMoves() {
  onValue(ref(db, "rooms/" + roomId + "/fen"), snap => {
    const fen = snap.val();
    if (fen && fen !== game.fen()) {
      game.load(fen);
      board.position(fen);
    }
  });
}
</script>

</body>
</html>
