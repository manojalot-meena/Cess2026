<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Online Chess - Firebase</title>

<!-- Chess Board -->
<link rel="stylesheet" href="https://unpkg.com/chessboardjs/dist/chessboard-1.0.0.min.css">

<style>
body {
  font-family: Arial;
  text-align: center;
  background: #f2f2f2;
}
#board {
  width: 320px;
  margin: 20px auto;
}
#status {
  margin-top: 10px;
  font-weight: bold;
}
</style>
</head>

<body>

<h2>‚ôüÔ∏è Online Chess</h2>
<div id="board"></div>
<div id="status">Connecting...</div>

<!-- Firebase -->
<script type="module">
  // üîπ Firebase core
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";

  // üîπ Auth (Anonymous)
  import { 
    getAuth, 
    signInAnonymously 
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

  // üîπ Realtime Database
  import { 
    getDatabase, 
    ref, 
    push, 
    set, 
    update, 
    onValue, 
    get 
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

  // üîπ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyACIKwrp-KV6o2vRM6adXESjU1-OpbVscc",
    authDomain: "cess-cb730.firebaseapp.com",
    databaseURL: "https://cess-cb730-default-rtdb.firebaseio.com",
    projectId: "cess-cb730",
    storageBucket: "cess-cb730.firebasestorage.app",
    messagingSenderId: "324360812002",
    appId: "1:324360812002:web:6a9bedb2cfc67db41a75bb"
  };

  // üîπ Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let uid;

  // üîê Anonymous Login
  signInAnonymously(auth).then(result => {
    uid = result.user.uid;
    console.log("Logged in:", uid);
    joinRandomRoom();
  });

  // üé≤ Random Chess Room Join
  async function joinRandomRoom() {
    const roomsRef = ref(db, "chessRooms");
    const snapshot = await get(roomsRef);

    let joined = false;

    if (snapshot.exists()) {
      snapshot.forEach(room => {
        const data = room.val();

        if (data.status === "waiting" && !data.black && !joined) {
          update(ref(db, "chessRooms/" + room.key), {
            black: uid,
            status: "playing"
          });
          console.log("Joined room:", room.key);
          joined = true;
        }
      });
    }

    if (!joined) {
      const newRoomRef = push(roomsRef);
      set(newRoomRef, {
        status: "waiting",
        white: uid,
        fen: "start",
        turn: "w"
      });
      console.log("Created room:", newRoomRef.key);
    }
  }
</script>

</body>
</html>